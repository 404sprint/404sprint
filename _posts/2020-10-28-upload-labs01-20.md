---
layout:     post
title:      upload-labs通关
subtitle:   文件上传漏洞初学
date:       2020-10-28
author:     Sprint#51264
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - 文件上传漏洞
---
# 引言

文件上传，通过各种绕过方式向指定服务器传含有恶意代码的非法文件或者上传不被允许的文件
***
# Pass-01
## 原理

js前端校验文件后缀是否合法，可以通过禁用js或者抓包改包达到绕过的目的

## 步骤
0.php一句话
`<?php @eval($POST_['x']); ?>`

1.向服务器上传.php一句话木马，发现上传被禁止

[![Bl73Zt.jpg](https://s1.ax1x.com/2020/10/28/Bl73Zt.jpg)](https://imgchr.com/i/Bl73Zt)

2.将含马文件改为允许上传的后缀名，例如1.jpg

3.打开代理，上传该文件并且进行抓包

[![Bl7Yi8.jpg](https://s1.ax1x.com/2020/10/28/Bl7Yi8.jpg)](https://imgchr.com/i/Bl7Yi8)

4.然后对其后缀进行更改为.php，页面会提示上传成功

5.然后需要知道上传到了什么路径，点击图片或者拖动图片新建一个标签页

[![Bl7tJS.jpg](https://s1.ax1x.com/2020/10/28/Bl7tJS.jpg)](https://imgchr.com/i/Bl7tJS)

知晓路径，然后用菜刀连接

***
# Pass-02
## 原理

发现利用上一题改后缀的方法也是可以绕过的，但是查看源码发现，这一题考的是content-type验证

[![Bl70Ln.jpg](https://s1.ax1x.com/2020/10/28/Bl70Ln.jpg)](https://imgchr.com/i/Bl70Ln)

所以我们利用修改content-type的方法进行绕过

## 步骤
1.这次可以直接对.php文件进行上传

2.抓包

[![Bl7DZq.jpg](https://s1.ax1x.com/2020/10/28/Bl7DZq.jpg)](https://imgchr.com/i/Bl7DZq)

3.对content-type属性值进行修改，因为这一次检验的是文件的MIME类型

我们将其改为image/gif 进行绕过

4.使用菜刀连接


***
# Pass-03
## 原理

代码审计

[![B8WMvR.jpg](https://s1.ax1x.com/2020/10/29/B8WMvR.jpg)](https://imgchr.com/i/B8WMvR)

黑名单过滤

1.对文件空进行过滤

2.对文件后缀进行截断并转换为小写，不能混写过

3.去除::$DATA

4.再次去空

5.文件保存时变为时间+随机数的形式


## 步骤
1.打开apache配置文件httpd.conf，添加

`AddType application/x-httpd-php .php .php3 .phtml`

允许解析含有该类后缀的文件

2.对写有小马的.phtml文件进行上传，然后用菜刀进行连接

>此处有必要提一下的就是用最新的phpstudy小皮面板更改配置之后也没有成功，要切换回老一点的版本2018版更改配置才能成功，我重新下载了2018版，可以正常做题


***
# Pass-04
## 原理

[![BWhipq.jpg](https://s1.ax1x.com/2020/11/06/BWhipq.jpg)](https://imgchr.com/i/BWhipq)

这次源码中对后缀进行了更为详细的黑名单限制

但是没有禁止.htaccess文件

对于该文件


[.htaccess教程：简介、访问控制、验证、目录浏览控制](https://www.cnblogs.com/wang1204/p/6617485.html)

## 步骤
0.首先要在apache服务器配置文件httpd.conf中设置

AllowOverride All

允许上传.htaccess文件

1.上传一个.htaccess文件内容写

`SetHandler AddType application/x-httpd-php`

就会将所有上传的文件解析为php文件

2.制作图片马，

使用windows下的copy命令

`copy 1.php/a + 2.jpg/b 3.jpg`

就制作完成了

3.上传3.jpg到服务器

***